# https://docs.github.com/en/actions/using-containerized-services/creating-postgresql-service-containers#running-jobs-directly-on-the-runner-machine

# Bun github-action documentation
# https://bun.sh/guides/runtime/cicd
# https://github.com/oven-sh/setup-bun

name: ds_auth_test

on:
 workflow_dispatch:
 pull_request_review:
  types: [submitted]
 pull_request_target:
  branches: [main]

jobs:
 # Label of the container job
 test-ds_auth:
  name:
   testing-disclone/ds_auth
   # Containers must run in Linux based operating systems
  runs-on: ubuntu-latest
  services:
   coruscant_db:
    image: postgres
    env:
     # See if this can reference env file
     POSTGRES_PASSWORD: password
     POSTGRES_HOST: coruscant_db
     POSTGRES_PORT: 5432
     POSTGRES_DB: disclone
     POSTGRES_USER: ds_auth
    # Set health checks to wait until postgres has started
    options: >-
     --health-cmd pg_isready
     --health-interval 10s
     --health-timeout 5s
     --health-retries 5
    ports:
     # Maps tcp port 5432 on service container to the host
     - 5432:5432

  steps:
   # Downloads a copy of the code in your repository before running CI tests
   - name: copy code into runner
     # official github action => copy repository's code into runner
     uses: actions/checkout@v3
     id: some id
   - name: setting-up bun
     # official bun action => sets up bun
     uses: oven-sh/setup-bun@v1
     with:
      bun-version: latest
   - name: install dependencies"
     working-directory: "./apps/ds_auth"
     run: bun install
   - name: Installing psql
     # using the directory
     # install postresql-client aka psql
     run: |
      apt-get update
      apt-get install --yes postgresql-client
   - name: seeding the database via postgresql client
     working-directory: "./db"
     # translation : psql connect to host coruscant_db with user ds_auth on the port 5432 to database disclone
     # inside psql shell import the file init_ds_auth.sql
     # quit psql shell with \q
     run: |
      psql -h coruscant_db -U ds_auth -p 5432 -d disclone && \i  init_ds_auth.sql && \q
   - name: run the goddamn tests for ds_auth
     run: bun run test
env:
 # The hostname used to communicate with the PostgreSQL service container
 POSTGRES_HOST: coruscant_db
 # The default PostgreSQL port
 POSTGRES_PORT: 5432
 # the database we're talking to
 POSTGRES_DB: disclone
 # the database user running commands
 POSTGRES_USER: ds_auth
 # the password for our POSTGRES_USER
 POSTGRES_PASSWORD: password
